import{a as Q,j as e,e as X,u as Z,r as d,n as ee,D as Se,f as be,g as we,B as w,h as ke,bd as k,R as te,aq as ve,b as Te,A as Ee,d8 as Pe,i as $,di as q,dj as De,dk as Ae,dl as Re,dm as $e,dn as Be,dp as Ne,da as Ue,av as Le,p as O,I as z,T as Fe}from"./index-RKOwH3L5.js";import{D as G,a as Ie,S as Oe}from"./StackedArrows-VOs40W91.js";import{C as ze,S as Me,e as _e,b as He,f as Ve,h as J,d as c,c as We,E as qe,g as Ge}from"./TextFieldSearch-D3BeTHhm.js";import{S as Y,I as Je}from"./TextField-BuG7cnXz.js";import{C as K}from"./Checkbox-FwaULwe1.js";import"./Select-HLbkRNVN.js";const Ye=Q(e.jsx("path",{fillRule:"evenodd",d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m4.9 13.49-1.4 1.4c-.2.2-.51.2-.71 0l-3.41-3.41c-1.22.43-2.64.17-3.62-.81-1.11-1.11-1.3-2.79-.59-4.1l2.35 2.35 1.41-1.41-2.35-2.34c1.32-.71 2.99-.52 4.1.59.98.98 1.24 2.4.81 3.62l3.41 3.41c.19.19.19.51 0 .7"}),"BuildCircle"),Ke=Q(e.jsx("path",{d:"M14 17H4v2h10zm6-8H4v2h16zM4 15h16v-2H4zM4 5v2h16V5z"}),"Subject");function Qe({open:g,onClose:v,onConfirm:B}){const{showSnackbar:f}=X(),{t:m}=Z(),[n,u]=d.useState(""),[j,C]=d.useState(""),[T,y]=d.useState({}),{showDialog:E}=ee(),N=m("Email composition"),P=m('In the email subject and in the email body you can use these "strings", enclosed among "$" signs, which will be replaced with the values for each user, before sending each email')+`: 

`+m(`     • $NAME$ => The name of the user
     • $SURNAME$ => The surname of the user
     • $EMAIL$ => The email of the user
     • $PHONE$ => The phone of the user
     • $ADDRESS$ => The address of the user
     • $FISCALCODE$ => The fiscal code/VAT of the user
     • $ROLES$ => The role or roles of the user
     • $PLAN$ => The plan of the user
     • $COMPANY$ => The company of the user
`),U=()=>{if(!n){let a=m("Please supply an email subject");return y({subject:a}),f(a,"warning"),!1}if(!j){let a=m("Please supply an email body");return y({body:a}),f(a,"warning"),!1}return!0},D=()=>{u(""),C("")},l=a=>{v(),D()},L=a=>{a.preventDefault(),U()&&(y({}),B({subject:n,body:j}),D())};return e.jsxs(Se,{open:g,onClose:v,fullWidth:!0,maxWidth:"sm",children:[e.jsx(be,{children:m("Create and send email")}),e.jsx(we,{children:e.jsxs(w,{display:"flex",flexDirection:"column",gap:2,children:[e.jsx(Y,{autoFocus:!0,id:"subject",value:n,onChange:a=>u(a.target.value),placeholder:m("Email subject"),InputProps:{startAdornment:e.jsx(Je,{position:"start",children:e.jsx(Ke,{})})},title:m("Subject"),error:T.subject}),e.jsx(w,{m:0}),e.jsx(Y,{id:"body",value:j,onChange:a=>C(a.target.value),placeholder:m("Email body"),error:T.body,multiline:!0,rows:4}),e.jsx(w,{m:0})]})}),e.jsxs(ke,{children:[e.jsx(k,{onClick:()=>E({title:N,message:P,confirmText:m("Ok")}),color:"secondary",variant:"contained",children:"?"}),e.jsx(k,{onClick:l,color:"secondary",variant:"contained",children:m("Cancel")}),e.jsx(k,{onClick:L,color:"primary",variant:"contained",children:m("Send email")})]})]})}const Xe=()=>{const g=ve(),v=Te(),{auth:B}=d.useContext(Ee),{showSnackbar:f}=X(),{showDialog:m}=ee(),{t:n}=Z(),[u,j]=d.useState([]),[C,T]=d.useState(""),[y,E]=d.useState(""),[N,P]=d.useState(!1),U=[5,10,25,50,100],D=t=>i.indexOf(t)!==-1,[l,L]=d.useState("lastName"),[a,se]=d.useState("asc");G.fromJSDate(new Date).setLocale(Pe.language).toLocaleString(G.DATETIME_FULL),d.useEffect(()=>((async()=>{const t=await $("get","/user/getAllUsersWithTokens");t.err?f(t.message,t.status===401?"warning":"error"):(j(t.users),P(!1))})(),()=>{}),[B.user,N]);const M=async t=>{const s=await $("post","/user/removeUser",t);return s.err?(f(s.message,"error"),!1):!0},ne=async t=>{const s=await $("post","/user/sendEmailToUsers",t);return s.err?(f(s.message,"error"),!1):!0},oe=async t=>{const s=await $("post","/user/promoteToDealer",{userId:t});return s.err?(f(s.message,"error"),!1):(s.count>0?f(n("User has been promoted to {{role}}",{role:n("dealer")}),"info"):f(n("User was a {{role}} already",{role:n("dealer")}),"info"),P(!0),!0)},re=t=>{v(`/edit-user/${t}/userEdit`)},_=async t=>{await M({filter:[t]})&&(j(o=>o.filter(r=>r._id!==t)),de(null))},ae=async(t,s)=>{ne({filter:t,...s})},H=async(t,s)=>{await M({filter:t,...s})&&(j(r=>r.filter(p=>!t.includes(p._id))),R([]),f(n("Removed {{count}} users",{count:t.length}),"success"))},[F,le]=d.useState(0),[A,ie]=d.useState(()=>parseInt(q.get("usersRowsPerPage"))||10),[i,R]=d.useState([]),[ce,de]=d.useState(null),ue=t=>{T(t.target.value)},me=(t,s)=>{le(s)},he=t=>{const s=parseInt(t.target.value);ie(s),q.set("usersRowsPerPage",s)},fe=t=>{if(t.target.checked){const s=u.map(o=>o._id);R(s);return}R([])},xe=(t,s)=>{const o=i.indexOf(s);let r=[];o===-1?r=r.concat(i,s):o===0?r=r.concat(i.slice(1)):o===i.length-1?r=r.concat(i.slice(0,-1)):o>0&&(r=r.concat(i.slice(0,o),i.slice(o+1))),R(r)},ge=(t,s)=>{switch(t){case"remove":_(ce);break;case"removeBulk":H(i);break;case"emailBulk":ae(i,s);break;default:f(n("Unforeseen bulk action {{action}}",{action:t}),"error")}},S=t=>()=>{let s="asc";l===t&&a==="asc"&&(s="desc"),L(t),se(s)},[pe,V]=d.useState(!1),je=t=>{E(t),V(!0)},W=()=>{V(!1),E("")},Ce=t=>{ge(i,y),W()},I=te.useMemo(()=>{let t=[...u];if(l!==null){const s=u.filter(r=>r[l]!==void 0),o=u.filter(r=>r[l]===void 0);return s.sort((r,p)=>{if(De(r[l])){const h=r[l].toLowerCase(),x=p[l].toLowerCase();return h<x?a==="asc"?-1:1:h>x?a==="asc"?1:-1:0}if(Ae(r[l])||Re(r[l])){const h=r[l],x=p[l];return h<x?a==="asc"?-1:1:h>x?a==="asc"?1:-1:0}if($e(r[l])){let h=r[l][0].priority,x=p[l][0].priority;return h<x?a==="asc"?-1:1:h>x?a==="asc"?1:-1:0}return Be(r[l])?a==="asc"?-1:1:Ne(r[l])?(console.warn(`sort of "object" field type for column ${l} is not implemented yet!`),0):(console.error(`sort of unknown field type for column ${l} is not implemented yet!`),0)}),a==="asc"?[...s,...o]:[...o,...s]}return t},[u,l,a]);d.useEffect(()=>{console.log("users:",u),console.log("sortedUsers:",I)},[u,I]);const ye=()=>{if(!u||!u.length)return[];const t=C==null?void 0:C.toLowerCase(),s=(o,r)=>{let p=o[r];return!o||!o[r]?!1:(r==="roles"&&(p=p.sort((h,x)=>h.priority<x.priority).map(h=>h.name.toLowerCase()).join(", ")),p.toString().toLowerCase().includes(t))};return I.filter(o=>s(o,"firstName")||s(o,"lastName")||s(o,"email")||s(o,"phone")||s(o,"roles")||s(o,"fiscalCode")||s(o,"businessName")).slice(F*A,F*A+A)},b=t=>e.jsx(Fe,{component:"span",children:l===t.column?a==="asc"?"▼":"▲":e.jsx(Oe,{opacity:.4})});return e.jsxs(e.Fragment,{children:[e.jsx(Ue,{children:n("Users handling")}),e.jsx(w,{sx:{my:g.spacing(2),display:"flex",justifyContent:"flex-end",width:"100%"},children:e.jsx(ze,{label:n("Search"),value:C,onChange:ue,startIcon:e.jsx(Me,{}),fullWidth:!1,sx:{color:g.palette.text.primary}})}),e.jsxs(Le,{sx:{overflow:"hidden",backgroundColor:g.palette.background.default,color:g.palette.text.secondary},children:[e.jsx(_e,{sx:{maxHeight:"max(12rem, calc(100vh - 26rem))"},children:e.jsxs(He,{stickyHeader:!0,"aria-label":"sticky table",children:[e.jsx(Ve,{children:e.jsxs(J,{sx:t=>({"& th":{backgroundColor:t.palette.secondary.main,color:t.palette.common.black,py:0,whiteSpace:"nowrap"}}),children:[e.jsx(c,{padding:"checkbox",children:e.jsx(K,{indeterminate:i.length>0&&i.length<u.length,checked:u.length>0&&i.length===u.length,onChange:fe})}),e.jsxs(c,{onClick:S("firstName"),children:[n("First name")," ",b({column:"firstName"})]}),e.jsxs(c,{onClick:S("lastName"),children:[n("Last name")," ",b({column:"lastName"})]}),e.jsxs(c,{onClick:S("email"),children:[n("Email")," ",b({column:"email"})]}),e.jsx(c,{children:n("Phone")}),e.jsxs(c,{onClick:S("roles"),children:[n("Roles")," ",b({column:"roles"})]}),e.jsx(c,{children:n("Fiscal code")}),e.jsxs(c,{onClick:S("businessName"),children:[n("Business name")," ",b({column:"businessName"})]}),e.jsx(c,{children:n("Actions")})]})}),e.jsx(We,{children:ye().map(t=>{const s=D(t._id);return e.jsxs(J,{hover:!0,onClick:o=>xe(o,t._id),role:"checkbox","aria-checked":s,tabIndex:-1,selected:s,sx:o=>({"& td":{backgroundColor:o.palette.ochre.light,color:o.palette.common.text,py:0}}),children:[e.jsx(c,{padding:"checkbox",children:e.jsx(K,{checked:s})}),e.jsx(c,{children:t.firstName}),e.jsx(c,{children:t.lastName}),e.jsx(c,{children:t.email}),e.jsx(c,{children:t.phone}),e.jsx(c,{children:t.roles.sort((o,r)=>o.priority<r.priority).map(o=>o.name).join(", ")}),e.jsx(c,{children:t.fiscalCode}),e.jsx(c,{children:t.businessName}),e.jsxs(c,{children:[e.jsx(O,{title:n("Edit user"),children:e.jsx(z,{size:"small",onClick:()=>re(t._id),children:e.jsx(qe,{fontSize:"small"})})}),e.jsx(O,{title:n("Promote to {{role}}",{role:"dealer"}),children:e.jsx(z,{size:"small",onClick:()=>oe(t._id),children:e.jsx(Ye,{fontSize:"small"})})}),e.jsx(O,{title:n("Remove user"),children:e.jsx(z,{size:"small",onClick:()=>m({onConfirm:()=>_(t._id),title:n("Confirm Delete"),message:n("Are you sure you want to delete selected {{count}} user?",{count:1}),confirmText:n("Confirm"),cancelText:n("Cancel")}),children:e.jsx(Ie,{fontSize:"small"})})})]})]},t._id)})})]})}),e.jsx(Ge,{rowsPerPageOptions:U,component:"div",count:u.length,rowsPerPage:A,page:F,onPageChange:me,onRowsPerPageChange:he}),e.jsxs(w,{sx:{padding:g.spacing(2)},children:[e.jsx(k,{variant:"contained",color:"primary",onClick:()=>je("emailBulk"),disabled:i.length===0,sx:{mr:g.spacing(2),my:.3},children:n("Email users")}),e.jsx(k,{variant:"contained",color:"primary",onClick:()=>m({onConfirm:()=>H(i),title:n("Confirm Delete"),message:n("Are you sure you want to delete selected {{count}} user?",{count:i.length}),confirmText:n("Confirm"),cancelText:n("Cancel")}),disabled:i.length===0,sx:{mr:g.spacing(2),my:.3},children:n("Remove users")})]})]}),e.jsx(Qe,{open:pe,onClose:W,onConfirm:Ce,message:n("Are you sure you want to send this email to {{count}} selected user?",{count:i.length}),confirmText:n("Send email to {{count}} selected users",{count:i.length}),cancelText:n("Cancel")})]})},rt=te.memo(Xe);export{rt as default};
